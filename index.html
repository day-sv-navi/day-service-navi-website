<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全国放課後等デイサービスナビ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        .facility-card { transition: transform 0.2s, box-shadow 0.2s; }
        .facility-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .modal { display: none; }
        .modal.active { display: flex; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-school text-2xl text-cyan-600"></i>
                <h1 class="text-xl font-bold text-stone-700">全国放課後等デイサービスナビ</h1>
            </div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" class="text-stone-600 hover:text-cyan-600 transition nav-link" data-target="home">ホーム</a>
                <a href="#" class="text-stone-600 hover:text-cyan-600 transition nav-link" data-target="results">施設を探す</a>
                <button id="login-button" class="bg-slate-600 text-white py-2 px-4 rounded-md hover:bg-slate-700 transition">ログイン</button>
                <button id="logout-button" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition hidden">ログアウト</button>
            </div>
            <button id="mobile-menu-button" class="md:hidden">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-white py-2">
             <a href="#" class="block px-4 py-2 text-stone-600 hover:bg-stone-100 nav-link" data-target="home">ホーム</a>
             <a href="#" class="block px-4 py-2 text-stone-600 hover:bg-stone-100 nav-link" data-target="results">施設を探す</a>
             <button id="mobile-login-button" class="block w-full text-left px-4 py-2 text-stone-600 hover:bg-stone-100">ログイン</button>
             <button id="mobile-logout-button" class="block w-full text-left px-4 py-2 text-stone-600 hover:bg-stone-100 hidden">ログアウト</button>
        </div>
    </header>

    <main>
        <div id="home-page" class="page active">
            <section class="bg-white">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-20 text-center">
                    <h2 class="text-3xl md:text-5xl font-extrabold text-cyan-700 mb-4">お子さまに最適な場所を、一緒に。</h2>
                    <p class="text-lg text-stone-600 max-w-3xl mx-auto">全国の放課後等デイサービスから、ご希望の地域やサービス内容で簡単に検索できます。まずは下のリストからお住まいの都道府県を選択してください。</p>
                    <button id="open-add-facility-modal" class="mt-8 bg-green-600 text-white py-3 px-6 rounded-md shadow-lg hover:bg-green-700 transition transform hover:scale-105 hidden">
                        <i class="fas fa-plus-circle mr-2"></i> 新しい事業所を登録する
                    </button>
                </div>
            </section>

            <section class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-4">都道府県を選択</h3>
                    <div id="prefecture-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- 都道府県リストがここに動的に挿入されます -->
                    </div>
                </div>
            </section>
        </div>

        <div id="results-page" class="page">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="mb-6">
                    <a href="#" class="text-cyan-600 hover:underline nav-link" data-target="home">&lt; 都道府県の選択に戻る</a>
                    <h2 id="results-title" class="text-3xl font-bold mt-2"></h2>
                    <p class="text-stone-600 mt-2">ここでは選択された地域の施設を地図とリストで確認できます。左のフィルターを使って、お子さまに合った条件で絞り込むことができます。</p>
                </div>

                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="w-full lg:w-1/4">
                        <div class="bg-white p-6 rounded-lg shadow sticky top-24">
                            <h3 class="text-lg font-bold mb-4 border-b pb-2">絞り込み検索</h3>
                            <div class="space-y-4" id="filter-options">
                                 <div>
                                    <label class="font-semibold text-stone-700">市区町村</label>
                                    <div id="results-city-filter" class="mt-2 space-y-1 max-h-48 overflow-y-auto"></div>
                                </div>
                                <div>
                                    <label class="font-semibold text-stone-700">サービス内容</label>
                                    <div id="service-filter" class="mt-2 space-y-1"></div>
                                </div>
                                <div>
                                    <label class="font-semibold text-stone-700">対象年齢</label>
                                    <div id="age-filter" class="mt-2 space-y-1"></div>
                                </div>
                                 <button id="reset-filters" class="w-full mt-4 bg-stone-500 text-white py-2 px-4 rounded-md hover:bg-stone-600 transition">リセット</button>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-lg font-bold mb-2 text-center">該当施設数</h3>
                                <p id="facility-count" class="text-2xl font-bold text-center text-cyan-700">0件</p>
                            </div>
                        </div>
                    </aside>
                    <div class="w-full lg:w-3/4">
                        <div id="facility-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        </div>
                         <div id="no-results" class="hidden text-center py-16 bg-white rounded-lg shadow">
                            <i class="fas fa-search text-4xl text-stone-400 mb-4"></i>
                            <p class="text-xl text-stone-600">該当する施設が見つかりませんでした。</p>
                            <p class="text-stone-500">検索条件を変更してみてください。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Facility Detail Modal -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-cyan-700"></h2>
                <button id="modal-close" class="text-2xl text-stone-500 hover:text-stone-800">&times;</button>
            </div>
            <div class="overflow-y-auto p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img id="modal-image" src="https://placehold.co/600x400/e2e8f0/64748b?text=Image" alt="施設画像" class="w-full h-64 object-cover rounded-md mb-4">
                        <h3 class="text-lg font-bold mb-2 border-b pb-1">基本情報</h3>
                        <p id="modal-address" class="text-stone-600 mb-2"></p>
                        <p id="modal-tel" class="text-stone-600 mb-2"></p>
                        <a id="modal-website" href="#" target="_blank" class="text-cyan-600 hover:underline hidden">ウェブサイトを見る <i class="fas fa-external-link-alt text-xs"></i></a>
                        <a id="modal-video-seminar" href="#" target="_blank" class="block mt-2 text-cyan-600 hover:underline">動画説明会の申込みはこちら！ <i class="fas fa-video text-xs"></i></a>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2 border-b pb-1">施設の特徴</h3>
                        <p id="modal-description" class="text-stone-600 mb-4"></p>
                        <h3 class="text-lg font-bold mb-2 border-b pb-1">提供サービス</h3>
                        <div id="modal-services" class="flex flex-wrap gap-2 mb-4"></div>
                        <h3 class="text-lg font-bold mb-2 border-b pb-1">対象年齢</h3>
                        <div id="modal-ages" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-700">管理者ログイン</h2>
                <button id="login-modal-close" class="text-2xl text-stone-500 hover:text-stone-800">&times;</button>
            </div>
            <div class="overflow-y-auto p-6">
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-stone-700">メールアドレス</label>
                        <input type="email" id="login-email" name="email" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-slate-500 focus:ring-slate-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-stone-700">パスワード</label>
                        <input type="password" id="login-password" name="password" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-slate-500 focus:ring-slate-500">
                    </div>
                    <button type="submit" class="w-full bg-slate-600 text-white py-2 px-4 rounded-md hover:bg-slate-700 transition">ログイン</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add New Facility Modal -->
    <div id="add-facility-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-cyan-700">新しい事業所を登録</h2>
                <button id="add-facility-modal-close" class="text-2xl text-stone-500 hover:text-stone-800">&times;</button>
            </div>
            <div class="overflow-y-auto p-6">
                <form id="add-facility-form" class="space-y-4">
                    <div>
                        <label for="add-facility-name" class="block text-sm font-medium text-stone-700">事業所名</label>
                        <input type="text" id="add-facility-name" name="name" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="add-facility-prefecture" class="block text-sm font-medium text-stone-700">都道府県</label>
                        <select id="add-facility-prefecture" name="prefecture" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500"></select>
                    </div>
                    <div>
                        <label for="add-facility-city" class="block text-sm font-medium text-stone-700">市区町村</label>
                        <select id="add-facility-city" name="city" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500"></select>
                    </div>
                    <div>
                        <label for="add-facility-address" class="block text-sm font-medium text-stone-700">詳細住所</label>
                        <input type="text" id="add-facility-address" name="address" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="add-facility-tel" class="block text-sm font-medium text-stone-700">電話番号</label>
                        <input type="tel" id="add-facility-tel" name="tel" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="add-facility-website" class="block text-sm font-medium text-stone-700">ウェブサイトURL</label>
                        <input type="url" id="add-facility-website" name="website" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="add-facility-videoSeminarLink" class="block text-sm font-medium text-stone-700">動画説明会リンク</label>
                        <input type="url" id="add-facility-videoSeminarLink" name="videoSeminarLink" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="add-facility-description" class="block text-sm font-medium text-stone-700">施設の特徴・説明</label>
                        <textarea id="add-facility-description" name="description" rows="3" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500"></textarea>
                    </div>
                    <div>
                        <label for="add-facility-image" class="block text-sm font-medium text-stone-700">画像URL</label>
                        <input type="url" id="add-facility-image" name="image" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700">提供サービス</label>
                        <div id="add-facility-services" class="mt-1 grid grid-cols-2 gap-2"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700">対象年齢</label>
                        <div id="add-facility-ages" class="mt-1 grid grid-cols-2 gap-2"></div>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 text-white py-2 px-4 rounded-md hover:bg-cyan-700 transition">登録する</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Facility Modal -->
    <div id="edit-facility-modal-container" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-bold text-cyan-700">事業所情報を編集</h2>
                <button id="edit-facility-modal-close" class="text-2xl text-stone-500 hover:text-stone-800">&times;</button>
            </div>
            <div class="overflow-y-auto p-6">
                <form id="edit-facility-form" class="space-y-4">
                    <input type="hidden" id="edit-facility-id" name="id">
                    <div>
                        <label for="edit-facility-name" class="block text-sm font-medium text-stone-700">事業所名</label>
                        <input type="text" id="edit-facility-name" name="name" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="edit-facility-prefecture" class="block text-sm font-medium text-stone-700">都道府県</label>
                        <select id="edit-facility-prefecture" name="prefecture" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500"></select>
                    </div>
                    <div>
                        <label for="edit-facility-city" class="block text-sm font-medium text-stone-700">市区町村</label>
                        <select id="edit-facility-city" name="city" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500"></select>
                    </div>
                    <div>
                        <label for="edit-facility-address" class="block text-sm font-medium text-stone-700">詳細住所</label>
                        <input type="text" id="edit-facility-address" name="address" required class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="edit-facility-tel" class="block text-sm font-medium text-stone-700">電話番号</label>
                        <input type="tel" id="edit-facility-tel" name="tel" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="edit-facility-website" class="block text-sm font-medium text-stone-700">ウェブサイトURL</label>
                        <input type="url" id="edit-facility-website" name="website" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                     <div>
                        <label for="edit-facility-videoSeminarLink" class="block text-sm font-medium text-stone-700">動画説明会リンク</label>
                        <input type="url" id="edit-facility-videoSeminarLink" name="videoSeminarLink" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label for="edit-facility-description" class="block text-sm font-medium text-stone-700">施設の特徴・説明</label>
                        <textarea id="edit-facility-description" name="description" rows="3" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500"></textarea>
                    </div>
                    <div>
                        <label for="edit-facility-image" class="block text-sm font-medium text-stone-700">画像URL</label>
                        <input type="url" id="edit-facility-image" name="image" class="mt-1 block w-full rounded-md border-stone-300 shadow-sm focus:border-cyan-500 focus:ring-cyan-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700">提供サービス</label>
                        <div id="edit-facility-services" class="mt-1 grid grid-cols-2 gap-2"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700">対象年齢</label>
                        <div id="edit-facility-ages" class="mt-1 grid grid-cols-2 gap-2"></div>
                    </div>
                    <button type="submit" class="w-full bg-cyan-600 text-white py-2 px-4 rounded-md hover:bg-cyan-700 transition">更新する</button>
                    <button type="button" id="delete-facility-btn" class="w-full mt-2 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition">この事業所を削除する</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div id="confirm-delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center">
            <p class="text-lg font-bold mb-4">本当にこの事業所を削除しますか？</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 transition">削除する</button>
                <button id="cancel-delete-btn" class="bg-stone-400 text-white py-2 px-4 rounded-md hover:bg-stone-500 transition">キャンセル</button>
            </div>
        </div>
    </div>

    <footer class="bg-stone-800 text-white mt-12">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
            <p>&copy; 2025 全国放課後等デイサービスナビ. All Rights Reserved.</p>
        </div>
    </footer>

    <!-- Application Logic -->
    <script type="module">
        let isAdmin = false; // Flag to check if the current user is an administrator

        // Global variables for DOM elements (will be assigned in initApp)
        let prefectureListContainer;
        let resultsTitle;
        let facilityList;
        let serviceFilter;
        let ageFilter;
        let resultsCityFilter;
        let noResults;
        let resetFiltersBtn;
        let facilityCountElement;
        let modalContainer;
        let modalContent;
        let modalClose;
        let modalVideoSeminar;
        let addFacilityModalContainer;
        let addFacilityModalClose;
        let addFacilityForm;
        let openAddFacilityModalBtn;
        let addFacilityPrefectureSelect;
        let addFacilityCitySelect;
        let addFacilityServicesCheckboxes;
        let addFacilityAgesCheckboxes;
        let editFacilityModalContainer;
        let editFacilityModalClose;
        let editFacilityForm;
        let editFacilityIdInput;
        let editFacilityPrefectureSelect;
        let editFacilityCitySelect;
        let editFacilityServicesCheckboxes;
        let editFacilityAgesCheckboxes;
        let deleteFacilityBtn;
        let confirmDeleteModal;
        let confirmDeleteBtn;
        let cancelDeleteBtn;
        let loginModalContainer;
        let loginModalClose;
        let loginForm;
        let loginButton;
        let logoutButton;
        let mobileLoginButton;
        let mobileLogoutButton;
        let pages;
        let navLinks;
        let mobileMenuButton;
        let mobileMenu;

        // Client-side data storage (NOT persistent - data will be lost on refresh)
        let allFacilities = [
            {
                id: '1',
                name: '札幌わくわく教室',
                prefecture: '北海道',
                city: '札幌市',
                address: '中央区大通西1丁目',
                tel: '011-123-4567',
                website: 'https://example.com/sapporo-wakuwaku',
                videoSeminarLink: 'https://youtube.com/watch?v=sapporo',
                description: '学習支援に力を入れた放課後等デイサービスです。個別指導で学力向上をサポートします。',
                image: 'https://placehold.co/600x400/a2d2ff/000000?text=Sapporo+Wakuwaku',
                services: ['学習支援', '送迎あり'],
                ages: ['小学生', '中学生']
            },
            {
                id: '2',
                name: '函館のびのびクラブ',
                prefecture: '北海道',
                city: '函館市',
                address: '五稜郭町44',
                tel: '0138-98-7654',
                website: 'https://example.com/hakodate-nobinobi',
                videoSeminarLink: 'https://youtube.com/watch?v=hakodate',
                description: '運動特化型のデイサービスで、広い体育館で体を動かすプログラムが豊富です。',
                image: 'https://placehold.co/600x400/bde0fe/000000?text=Hakodate+Nobinobi',
                services: ['運動特化', '送迎あり'],
                ages: ['未就学児', '小学生']
            },
            {
                id: '3',
                name: '旭川アートラボ',
                prefecture: '北海道',
                city: '旭川市',
                address: '宮下通7丁目',
                tel: '0166-55-1122',
                website: 'https://example.com/asahikawa-artlab',
                videoSeminarLink: '',
                description: '創作活動を通じて自己表現を育むアートに特化したデイサービスです。',
                image: 'https://placehold.co/600x400/cddafd/000000?text=Asahikawa+ArtLab',
                services: ['創作活動'],
                ages: ['小学生', '中学生', '高校生']
            },
            {
                id: '4',
                name: '青森りんごの家',
                prefecture: '青森',
                city: '青森市',
                address: '新町1丁目',
                tel: '017-111-2222',
                website: 'https://example.com/aomori-ringo',
                videoSeminarLink: '',
                description: 'SST（ソーシャルスキルトレーニング）に力を入れています。',
                image: 'https://placehold.co/600x400/ffc8dd/000000?text=Aomori+Ringo',
                services: ['SST', '送迎あり'],
                ages: ['小学生']
            },
             {
                id: '5',
                name: '仙台未来学習塾',
                prefecture: '宮城',
                city: '仙台市',
                address: '青葉区中央2丁目',
                tel: '022-333-4444',
                website: 'https://example.com/sendai-mirai',
                videoSeminarLink: 'https://youtube.com/watch?v=sendai',
                description: '個別学習支援とプログラミング教育に特化した施設です。',
                image: 'https://placehold.co/600x400/a2d2ff/000000?text=Sendai+Mirai',
                services: ['学習支援', 'PCスキル'],
                ages: ['中学生', '高校生']
            },
            {
                id: '6',
                name: '東京スマイルラボ',
                prefecture: '東京',
                city: '世田谷区',
                address: '世田谷区桜新町2丁目',
                tel: '03-1234-5678',
                website: 'https://example.com/tokyo-smile',
                videoSeminarLink: 'https://youtube.com/watch?v=tokyo',
                description: '多様なプログラムを提供する総合的な放課後等デイサービスです。',
                image: 'https://placehold.co/600x400/bde0fe/000000?text=Tokyo+Smile',
                services: ['学習支援', '運動特化', 'SST', '送迎あり'],
                ages: ['未就学児', '小学生', '中学生', '高校生']
            },
            {
                id: '7',
                name: '横浜チャレンジクラブ',
                prefecture: '神奈川',
                city: '横浜市',
                address: '中区山下町1丁目',
                tel: '045-987-6543',
                website: 'https://example.com/yokohama-challenge',
                videoSeminarLink: '',
                description: 'スポーツと地域交流を重視した活動を行っています。',
                image: 'https://placehold.co/600x400/cddafd/000000?text=Yokohama+Challenge',
                services: ['運動特化', '送迎あり'],
                ages: ['小学生', '中学生']
            },
            {
                id: '8',
                name: '名古屋クリエイティブハウス',
                prefecture: '愛知',
                city: '名古屋市',
                address: '中区栄3丁目',
                tel: '052-222-3333',
                website: 'https://example.com/nagoya-creative',
                videoSeminarLink: 'https://youtube.com/watch?v=nagoya',
                description: 'アートと音楽活動に特化し、創造性を育みます。',
                image: 'https://placehold.co/600x400/ffc8dd/000000?text=Nagoya+Creative',
                services: ['創作活動'],
                ages: ['未就学児', '小学生']
            }
        ];
        let currentEditingFacilityId = null; // For edit/delete operations
        let currentState = {
            prefecture: null,
            city: [],
            services: [],
            ages: []
        };

        // Hardcoded admin credentials for client-side only (NOT secure for production)
        const ADMIN_EMAIL = "admin@example.com";
        const ADMIN_PASSWORD = "password"; // Please change this in a real application!

        const prefectures = [
            { id: 1, name: "北海道" }, { id: 2, name: "青森" }, { id: 3, name: "岩手" },
            { id: 4, name: "宮城" }, { id: 5, name: "秋田" }, { id: 6, name: "山形" },
            { id: 7, name: "福島" }, { id: 8, name: "茨城" }, { id: 9, name: "栃木" },
            { id: 10, name: "群馬" }, { id: 11, name: "埼玉" }, { id: 12, name: "千葉" },
            { id: 13, name: "東京" }, { id: 14, name: "神奈川" }, { id: 15, name: "新潟" },
            { id: 16, name: "富山" }, { id: 17, name: "石川" }, { id: 18, name: "福井" },
            { id: 19, name: "山梨" }, { id: 20, name: "長野" }, { id: 21, name: "岐阜" },
            { id: 22, name: "静岡" }, { id: 23, name: "愛知" }, { id: 24, name: "三重" },
            { id: 25, name: "滋賀" }, { id: 26, name: "京都" }, { id: 27, name: "大阪" },
            { id: 28, name: "兵庫" }, { id: 29, name: "奈良" }, { id: 30, name: "和歌山" },
            { id: 31, name: "鳥取" }, { id: 32, name: "島根" }, { id: 33, name: "岡山" },
            { id: 34, name: "広島" }, { id: 35, name: "山口" }, { id: 36, name: "徳島" },
            { id: 37, name: "香川" }, { id: 38, name: "愛媛" }, { id: 39, name: "高知" },
            { id: 40, name: "福岡" }, { id: 41, name: "佐賀" }, { id: 42, name: "長崎" },
            { id: 43, name: "熊本" }, { id: 44, name: "大分" }, { id: 45, name: "宮崎" },
            { id: 46, name: "鹿児島" }, { id: 47, name: "沖縄" }
        ];

        const serviceTypes = ["学習支援", "運動特化", "SST", "創作活動", "PCスキル", "送迎あり"];
        const ageGroups = ["未就学児", "小学生", "中学生", "高校生"];

        const citiesByPrefecture = {
            "北海道": ["札幌市", "函館市", "旭川市", "小樽市", "帯広市", "釧路市", "苫小牧市", "北見市", "江別市", "千歳市", "その他自治体"],
            "青森": ["青森市", "弘前市", "八戸市", "五所川原市", "十和田市", "三沢市", "むつ市", "つがる市", "その他自治体"],
            "岩手": ["盛岡市", "一関市", "奥州市", "花巻市", "北上市", "遠野市", "釜石市", "宮古市", "その他自治体"],
            "宮城": ["仙台市", "石巻市", "大崎市", "登米市", "栗原市", "名取市", "気仙沼市", "多賀城市", "その他自治体"],
            "秋田": ["秋田市", "横手市", "大仙市", "能代市", "湯沢市", "由利本荘市", "男鹿市", "その他自治体"],
            "山形": ["山形市", "米沢市", "鶴岡市", "酒田市", "新庄市", "東根市", "天童市", "その他自治体"],
            "福島": ["福島市", "郡山市", "いわき市", "会津若松市", "白河市", "須賀川市", "喜多方市", "二本松市", "その他自治体"],
            "茨城": ["水戸市", "つくば市", "日立市", "土浦市", "古河市", "取手市", "牛久市", "ひたちなか市", "鹿嶋市", "その他自治体"],
            "栃木": ["宇都宮市", "小山市", "栃木市", "佐野市", "那須塩塩原市", "足利市", "鹿沼市", "日光市", "その他自治体"],
            "群馬": ["前橋市", "高崎市", "桐生市", "伊勢崎市", "太田市", "沼田市", "渋川市", "藤岡市", "富岡市", "その他自治体"],
            "埼玉": ["さいたま市", "川口市", "川越市", "越谷市", "所沢市", "熊谷市", "草加市", "春日部市", "新座市", "狭山市", "久喜市", "その他自治体"],
            "千葉": ["千葉市", "船橋市", "柏市", "市川市", "松戸市", "浦安市", "成田市", "木更津市", "佐倉市", "習志野市", "その他自治体"],
            "東京": ["千代田区", "中央区", "港区", "新宿区", "文京区", "台東区", "墨田区", "江東区", "品川区", "目黒区", "大田区", "世田谷区", "渋谷区", "中野区", "杉並区", "豊島区", "北区", "荒川区", "板橋区", "練馬区", "足立区", "葛飾区", "江戸川区", "八王子市", "立川市", "武蔵野市", "府中市", "町田市", "調布市", "三鷹市", "青梅市", "その他自治体"],
            "神奈川": ["横浜市", "川崎市", "相模原市", "藤沢市", "鎌倉市", "厚木市", "横須賀市", "平塚市", "小田原市", "茅ヶ崎市", "大和市", "その他自治体"],
            "新潟": ["新潟市", "長岡市", "上越市", "三条市", "柏崎市", "新発田市", "佐渡市", "見附市", "村上市", "その他自治体"],
            "富山": ["富山市", "高岡市", "魚津市", "砺波市", "滑川市", "射水市", "南砺市", "氷見市", "その他自治体"],
            "石川": ["金沢市", "小松市", "七尾市", "加賀市", "白山市", "野々市市", "能美市", "かほく市", "その他自治体"],
            "福井": ["福井市", "敦賀市", "鯖江市", "越前市", "大野市", "小浜市", "勝山市", "その他自治体"],
            "山梨": ["甲府市", "富士吉田市", "大月市", "笛吹市", "韮崎市", "南アルプス市", "甲斐市", "山梨市", "その他自治体"],
            "長野": ["長野市", "松本市", "上田市", "飯田市", "佐久市", "安曇野市", "伊那市", "諏訪市", "茅野市", "その他自治体"],
            "岐阜": ["岐阜市", "大垣市", "高山市", "多治見市", "関市", "中津川市", "各務原市", "可児市", "羽島市", "その他自治体"],
            "静岡": ["静岡市", "浜松市", "沼津市", "富士市", "磐田市", "焼津市", "藤枝市", "三島市", "富士宮市", "掛川市", "その他自治体"],
            "愛知": ["名古屋市", "豊田市", "岡崎市", "一宮市", "豊橋市", "春日井市", "安城市", "刈谷市", "小牧市", "稲沢市", "半田市", "その他自治体"],
            "三重": ["津市", "四日市市", "伊勢市", "松阪市", "桑名市", "鈴鹿市", "名張市", "亀山市", "いなべ市", "その他自治体"],
            "滋賀": ["大津市", "彦根市", "長浜市", "草津市", "守山市", "栗東市", "東近江市", "近江八幡市", "甲賀市", "その他自治体"],
            "京都": ["京都市", "宇治市", "亀岡市", "舞鶴市", "福知山市", "城陽市", "木津川市", "八幡市", "京田辺市", "その他自治体"],
            "大阪": ["大阪市", "堺市", "豊中市", "吹田市", "東大阪市", "高槻市", "枚方市", "八尾市", "寝屋川市", "岸和田市", "和泉市", "茨木市", "その他自治体"],
            "兵庫": ["神戸市", "姫路市", "西宮市", "尼崎市", "明石市", "伊丹市", "加古川市", "宝塚市", "芦屋市", "淡路市", "三田市", "その他自治体"],
            "奈良": ["奈良市", "橿原市", "生駒市", "大和郡山市", "天理市", "桜井市", "五條市", "御所市", "香芝市", "その他自治体"],
            "和歌山": ["和歌山市", "田辺市", "新宮市", "海南市", "紀の川市", "橋本市", "有田市", "御坊市", "その他自治体"],
            "鳥取": ["鳥取市", "米子市", "倉吉市", "境港市", "その他自治体"],
            "島根": ["松江市", "出雲市", "浜田市", "益田市", "大田市", "安来市", "その他自治体"],
            "岡山": ["岡山市", "倉敷市", "津山市", "玉野市", "笠岡市", "総社市", "高梁市", "新見市", "その他自治体"],
            "広島": ["広島市", "福山市", "呉市", "東広島市", "尾道市", "廿日市市", "三原市", "三次市", "その他自治体"],
            "山口": ["山口市", "下関市", "宇部市", "周南市", "岩国市", "防府市", "光市", "長門市", "その他自治体"],
            "徳島": ["徳島市", "鳴門市", "小松島市", "阿南市", "吉野川市", "美馬市", "阿波市", "その他自治体"],
            "香川": ["高松市", "丸亀市", "三豊市", "観音寺市", "坂出市", "さぬき市", "善通寺市", "その他自治体"],
            "愛媛": ["松山市", "今治市", "新居浜市", "西条市", "四国中央市", "宇和島市", "大洲市", "伊予市", "その他自治体"],
            "高知": ["高知市", "四万十市", "南国市", "安芸市", "土佐市", "須崎市", "宿毛市", "その他自治体"],
            "福岡": ["福岡市", "北九州市", "久留米市", "飯塚市", "大牟田市", "春日市", "宗像市", "筑紫野市", "糸島市", "太宰府市", "福津市", "その他自治体"],
            "佐賀": ["佐賀市", "唐津市", "鳥栖市", "武雄市", "伊万里市", "小城市", "鹿島市", "その他自治体"],
            "長崎": ["長崎市", "佐世保市", "大村市", "諫早市", "島原市", "五島市", "壱岐市", "対馬市", "その他自治体"],
            "熊本": ["熊本市", "八代市", "天草市", "玉名市", "山鹿市", "菊池市", "荒尾市", "宇土市", "その他自治体"],
            "大分": ["大分市", "別府市", "中津市", "日田市", "佐伯市", "宇佐市", "豊後大野市", "その他自治体"],
            "宮崎": ["宮崎市", "都城市", "延岡市", "日向市", "小林市", "日南市", "えびの市", "その他自治体"],
            "鹿児島": ["鹿児島市", "霧島市", "鹿屋市", "薩摩川内市", "出水市", "奄美市", "曽於市", "いちき串木野市", "その他自治体"],
            "沖縄": ["那覇市", "沖縄市", "浦添市", "うるま市", "宜野湾市", "名護市", "豊見城市", "石垣市", "宮古島市", "糸満市", "その他自治体"]
        };

        // Function to populate select options
        const populateSelect = (selectElement, options, selectedValue = null) => {
            selectElement.innerHTML = '<option value="">選択してください</option>';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.name || option;
                opt.textContent = option.name || option;
                if (selectedValue && opt.value === selectedValue) {
                    opt.selected = true;
                }
                selectElement.appendChild(opt);
            });
        };

        // Function to populate checkboxes
        const populateCheckboxes = (containerElement, items, dataFilterName, selectedItems = []) => {
            containerElement.innerHTML = '';
            items.forEach(item => {
                const div = document.createElement('div');
                const isChecked = selectedItems.includes(item);
                div.innerHTML = `
                    <label class="flex items-center space-x-2 text-stone-600">
                        <input type="checkbox" class="form-checkbox h-4 w-4 text-cyan-600 border-stone-300 rounded focus:ring-cyan-500 ${dataFilterName}-checkbox" data-filter="${dataFilterName}" value="${item}" ${isChecked ? 'checked' : ''}>
                        <span>${item}</span>
                    </label>
                `;
                containerElement.appendChild(div);
            });
        };

        // Function to render facility results
        const renderResults = () => {
            if (!currentState.prefecture) {
                facilityList.innerHTML = '';
                noResults.classList.remove('hidden');
                facilityCountElement.textContent = `0件`;
                return;
            }

            resultsTitle.textContent = `${currentState.prefecture}の放課後等デイサービス`;

            let filteredFacilities = allFacilities.filter(f => f.prefecture === currentState.prefecture);

            let citiesToFilterBy = [...currentState.city];
            const hasOtherMunicipalitiesSelected = citiesToFilterBy.includes("その他自治体");
            const hasSpecificCitiesSelected = citiesToFilterBy.some(city => city !== "その他自治体");

            if (hasOtherMunicipalitiesSelected && !hasSpecificCitiesSelected) {
                citiesToFilterBy = [];
            } else if (hasOtherMunicipalitiesSelected && hasSpecificCitiesSelected) {
                citiesToFilterBy = citiesToFilterBy.filter(city => city !== "その他自治体");
            }

            if (citiesToFilterBy.length > 0) {
                filteredFacilities = filteredFacilities.filter(f => citiesToFilterBy.includes(f.city));
            }
            if (currentState.services.length > 0) {
                filteredFacilities = filteredFacilities.filter(f => currentState.services.every(s => f.services.includes(s)));
            }
            if (currentState.ages.length > 0) {
                filteredFacilities = filteredFacilities.filter(f => currentState.ages.every(a => f.ages.includes(a)));
            }

            facilityList.innerHTML = '';
            if (filteredFacilities.length > 0) {
                noResults.classList.add('hidden');
                facilityList.classList.remove('hidden');
                filteredFacilities.forEach(facility => {
                    const card = document.createElement('div');
                    card.className = 'facility-card bg-white rounded-lg shadow-md overflow-hidden cursor-pointer fade-in';
                    card.innerHTML = `
                        <img src="${facility.image || 'https://placehold.co/600x400/e2e8f0/64748b?text=No+Image'}" alt="${facility.name}" class="w-full h-40 object-cover">
                        <div class="p-4">
                            <h4 class="font-bold text-lg text-stone-800">${facility.name}</h4>
                            <p class="text-sm text-stone-500 mb-2"><i class="fas fa-map-marker-alt mr-1"></i>${facility.prefecture}${facility.address}</p>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${(facility.services || []).map(s => `<span class="bg-cyan-100 text-cyan-800 text-xs font-semibold px-2 py-1 rounded-full">${s}</span>`).join('')}
                            </div>
                            <div class="mt-3 flex justify-end space-x-2 ${isAdmin ? '' : 'hidden'}">
                                <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 transition" data-id="${facility.id}">編集</button>
                                <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition" data-id="${facility.id}">削除</button>
                            </div>
                        </div>
                    `;
                    // Check if buttons exist before adding event listeners
                    card.querySelector('.edit-btn')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openEditFacilityModal(facility);
                    });
                    card.querySelector('.delete-btn')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentEditingFacilityId = facility.id;
                        confirmDeleteModal.classList.remove('hidden');
                    });
                    card.addEventListener('click', () => openModal(facility));
                    facilityList.appendChild(card);
                });
            } else {
                noResults.classList.remove('hidden');
                facilityList.classList.add('hidden');
            }
            facilityCountElement.textContent = `${filteredFacilities.length}件`;
        };

        // Function to update UI based on authentication status
        function updateAuthUI() {
            if (isAdmin) {
                loginButton.classList.add('hidden');
                logoutButton.classList.remove('hidden');
                openAddFacilityModalBtn.classList.remove('hidden'); // Show add button for admin
                mobileLoginButton.classList.add('hidden');
                mobileLogoutButton.classList.remove('hidden');
            } else {
                loginButton.classList.remove('hidden');
                logoutButton.classList.add('hidden');
                openAddFacilityModalBtn.classList.add('hidden'); // Hide add button for non-admin
                mobileLoginButton.classList.remove('hidden');
                mobileLogoutButton.classList.add('hidden');
            }
            // Re-render results to update edit/delete buttons visibility
            renderResults();
        }

        // Main application initialization function, called after the DOM is fully loaded
        function initApp() {
            console.log("Application initializing...");
            // Assign DOM elements to global variables
            prefectureListContainer = document.getElementById('prefecture-list');
            resultsTitle = document.getElementById('results-title');
            facilityList = document.getElementById('facility-list');
            serviceFilter = document.getElementById('service-filter');
            ageFilter = document.getElementById('age-filter');
            resultsCityFilter = document.getElementById('results-city-filter');
            noResults = document.getElementById('no-results');
            resetFiltersBtn = document.getElementById('reset-filters');
            facilityCountElement = document.getElementById('facility-count');

            modalContainer = document.getElementById('modal-container');
            modalContent = document.getElementById('modal-content');
            modalClose = document.getElementById('modal-close');
            modalVideoSeminar = document.getElementById('modal-video-seminar');

            addFacilityModalContainer = document.getElementById('add-facility-modal-container');
            addFacilityModalClose = document.getElementById('add-facility-modal-close');
            addFacilityForm = document.getElementById('add-facility-form');
            openAddFacilityModalBtn = document.getElementById('open-add-facility-modal');

            addFacilityPrefectureSelect = document.getElementById('add-facility-prefecture');
            addFacilityCitySelect = document.getElementById('add-facility-city');
            addFacilityServicesCheckboxes = document.getElementById('add-facility-services');
            addFacilityAgesCheckboxes = document.getElementById('add-facility-ages');

            editFacilityModalContainer = document.getElementById('edit-facility-modal-container');
            editFacilityModalClose = document.getElementById('edit-facility-modal-close');
            editFacilityForm = document.getElementById('edit-facility-form');
            editFacilityIdInput = document.getElementById('edit-facility-id');
            editFacilityPrefectureSelect = document.getElementById('edit-facility-prefecture');
            editFacilityCitySelect = document.getElementById('edit-facility-city');
            editFacilityServicesCheckboxes = document.getElementById('edit-facility-services');
            editFacilityAgesCheckboxes = document.getElementById('edit-facility-ages');
            deleteFacilityBtn = document.getElementById('delete-facility-btn');
            confirmDeleteModal = document.getElementById('confirm-delete-modal');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');

            loginModalContainer = document.getElementById('login-modal-container');
            loginModalClose = document.getElementById('login-modal-close');
            loginForm = document.getElementById('login-form');
            loginButton = document.getElementById('login-button');
            logoutButton = document.getElementById('logout-button');
            mobileLoginButton = document.getElementById('mobile-login-button');
            mobileLogoutButton = document.getElementById('mobile-logout-button');


            pages = document.querySelectorAll('.page');
            navLinks = document.querySelectorAll('.nav-link');
            mobileMenuButton = document.getElementById('mobile-menu-button');
            mobileMenu = document.getElementById('mobile-menu');

            // All DOM elements are now assigned. Proceed with event listeners and initial setup.

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // Add event listeners for mobile login/logout buttons
            mobileLoginButton.addEventListener('click', () => {
                loginModalContainer.classList.remove('hidden');
                mobileMenu.classList.add('hidden'); // Close mobile menu after clicking login
            });

            mobileLogoutButton.addEventListener('click', () => {
                isAdmin = false; // Set admin status to false on logout
                alert('ログアウトしました。');
                mobileMenu.classList.add('hidden'); // Close mobile menu after logging out
                updateAuthUI(); // Update UI after logout
            });

            const setupFilters = () => {
                populateCheckboxes(serviceFilter, serviceTypes, 'services');
                populateCheckboxes(ageFilter, ageGroups, 'ages');

                document.querySelectorAll('.filter-checkbox').forEach(cb => {
                    cb.addEventListener('change', handleFilterChange);
                });
            };

            const setupNavigation = () => {
                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetId = e.currentTarget.dataset.target;

                        if (targetId === 'results' && !currentState.prefecture) {
                            alert('まず都道府県を選択してください。');
                            return;
                        }

                        pages.forEach(page => {
                            if (page.id === `${targetId}-page`) {
                                page.classList.add('active');
                            } else {
                                page.classList.remove('active');
                            }
                        });
                        if (mobileMenu.classList.contains('hidden') === false) {
                            mobileMenu.classList.add('hidden');
                        }
                    });
                });
            };

            const setupModal = () => {
                modalClose.addEventListener('click', () => modalContainer.classList.add('hidden'));
                modalContainer.addEventListener('click', (e) => {
                    if (e.target === modalContainer) {
                        modalContainer.classList.add('hidden');
                    }
                });
            };

            const selectPrefecture = (prefName) => {
                if (!prefName || !citiesByPrefecture[prefName]) {
                    alert(`「${prefName}」のデータは現在準備中です。`);
                    return;
                }
                currentState.prefecture = prefName;
                currentState.city = []; // Reset city filter when prefecture changes
                // No need to uncheck city filters here, updateCityFilter will rebuild them
                updateCityFilter();
                renderResults();

                pages.forEach(page => page.classList.remove('active'));
                document.getElementById('results-page').classList.add('active');
            };

            const updateCityFilter = () => {
                resultsCityFilter.innerHTML = '';
                const cities = citiesByPrefecture[currentState.prefecture] || [];
                populateCheckboxes(resultsCityFilter, cities, 'city', currentState.city);

                document.querySelectorAll('.city-filter-checkbox').forEach(cb => {
                    cb.addEventListener('change', handleFilterChange);
                });
            };

            const handleFilterChange = () => {
                currentState.city = Array.from(document.querySelectorAll('.city-filter-checkbox:checked')).map(cb => cb.value);
                currentState.services = Array.from(document.querySelectorAll('[data-filter="services"]:checked')).map(cb => cb.value);
                currentState.ages = Array.from(document.querySelectorAll('[data-filter="ages"]:checked')).map(cb => cb.value);
                renderResults();
            };

            const resetFilters = () => {
                currentState.city = [];
                currentState.services = [];
                currentState.ages = [];
                document.querySelectorAll('.filter-checkbox, .city-filter-checkbox').forEach(cb => cb.checked = false);
                renderResults();
            };

            const openModal = (facility) => {
                document.getElementById('modal-title').textContent = facility.name;
                document.getElementById('modal-image').src = facility.image || 'https://placehold.co/600x400/e2e8f0/64748b?text=No+Image';
                document.getElementById('modal-image').alt = facility.name;
                document.getElementById('modal-address').innerHTML = `<i class="fas fa-map-marker-alt mr-2 text-stone-500"></i>${facility.prefecture}${facility.address}`;
                document.getElementById('modal-tel').innerHTML = `<i class="fas fa-phone mr-2 text-stone-500"></i>${facility.tel}`;
                document.getElementById('modal-website').href = facility.website || '#';
                document.getElementById('modal-website').classList.toggle('hidden', !facility.website);
                modalVideoSeminar.href = facility.videoSeminarLink || '#';
                modalVideoSeminar.style.display = facility.videoSeminarLink ? 'block' : 'none';

                document.getElementById('modal-description').textContent = facility.description;

                const servicesEl = document.getElementById('modal-services');
                servicesEl.innerHTML = (facility.services || []).map(s => `<span class="bg-teal-100 text-teal-800 text-sm font-medium px-3 py-1 rounded-full">${s}</span>`).join('');

                const agesEl = document.getElementById('modal-ages');
                agesEl.innerHTML = (facility.ages || []).map(a => `<span class="bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1 rounded-full">${a}</span>`).join('');

                modalContainer.classList.remove('hidden');
            };

            // --- Login Modal Functions ---
            loginButton.addEventListener('click', () => {
                loginModalContainer.classList.remove('hidden');
            });

            loginModalClose.addEventListener('click', () => loginModalContainer.classList.add('hidden'));
            loginModalContainer.addEventListener('click', (e) => {
                if (e.target === loginModalContainer) {
                    loginModalContainer.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                    isAdmin = true;
                    alert('ログインしました！');
                    loginModalContainer.classList.add('hidden');
                    updateAuthUI(); // Update UI after successful login
                } else {
                    alert('ログインに失敗しました。メールアドレスまたはパスワードが間違っています。');
                }
            });

            logoutButton.addEventListener('click', () => {
                isAdmin = false; // Set admin status to false on logout
                alert('ログアウトしました。');
                updateAuthUI(); // Update UI after logout
            });


            // --- Add Facility Modal Functions ---
            openAddFacilityModalBtn.addEventListener('click', () => {
                addFacilityForm.reset();
                populateSelect(addFacilityPrefectureSelect, prefectures);
                addFacilityCitySelect.innerHTML = '<option value="">都道府県を選択してください</option>'; // Reset city select
                populateCheckboxes(addFacilityServicesCheckboxes, serviceTypes, 'add-facility-services');
                populateCheckboxes(addFacilityAgesCheckboxes, ageGroups, 'add-facility-ages');
                addFacilityModalContainer.classList.remove('hidden');
            });

            addFacilityModalClose.addEventListener('click', () => addFacilityModalContainer.classList.add('hidden'));
            addFacilityModalContainer.addEventListener('click', (e) => {
                if (e.target === addFacilityModalContainer) {
                    addFacilityModalContainer.classList.add('hidden');
                }
            });

            addFacilityPrefectureSelect.addEventListener('change', (e) => {
                const selectedPref = e.target.value;
                const cities = citiesByPrefecture[selectedPref] || [];
                populateSelect(addFacilityCitySelect, cities);
            });

            addFacilityForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(addFacilityForm);
                const newFacility = {
                    id: Date.now().toString(), // Simple unique ID
                    name: formData.get('name'),
                    prefecture: formData.get('prefecture'),
                    city: formData.get('city'),
                    address: formData.get('address'),
                    tel: formData.get('tel'),
                    website: formData.get('website'),
                    videoSeminarLink: formData.get('videoSeminarLink'),
                    description: formData.get('description'),
                    image: formData.get('image') || 'https://placehold.co/600x400/e2e8f0/64748b?text=No+Image', // Default image
                    services: Array.from(addFacilityServicesCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value),
                    ages: Array.from(addFacilityAgesCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value),
                };

                allFacilities.push(newFacility);
                alert('事業所情報が正常に登録されました！');
                addFacilityModalContainer.classList.add('hidden');
                renderResults(); // Re-render to show new facility
            });

            // --- Edit Facility Modal Functions ---
            const openEditFacilityModal = (facility) => {
                currentEditingFacilityId = facility.id;
                editFacilityIdInput.value = facility.id;
                document.getElementById('edit-facility-name').value = facility.name;
                document.getElementById('edit-facility-address').value = facility.address;
                document.getElementById('edit-facility-tel').value = facility.tel;
                document.getElementById('edit-facility-website').value = facility.website;
                document.getElementById('edit-facility-videoSeminarLink').value = facility.videoSeminarLink;
                document.getElementById('edit-facility-description').value = facility.description;
                document.getElementById('edit-facility-image').value = facility.image;

                populateSelect(editFacilityPrefectureSelect, prefectures, facility.prefecture);
                const cities = citiesByPrefecture[facility.prefecture] || [];
                populateSelect(editFacilityCitySelect, cities, facility.city);

                populateCheckboxes(editFacilityServicesCheckboxes, serviceTypes, 'edit-facility-services', facility.services);
                populateCheckboxes(editFacilityAgesCheckboxes, ageGroups, 'edit-facility-ages', facility.ages);

                editFacilityModalContainer.classList.remove('hidden');
            };

            editFacilityModalClose.addEventListener('click', () => editFacilityModalContainer.classList.add('hidden'));
            editFacilityModalContainer.addEventListener('click', (e) => {
                if (e.target === editFacilityModalContainer) {
                    editFacilityModalContainer.classList.add('hidden');
                }
            });

            editFacilityPrefectureSelect.addEventListener('change', (e) => {
                const selectedPref = e.target.value;
                const cities = citiesByPrefecture[selectedPref] || [];
                populateSelect(editFacilityCitySelect, cities);
            });

            editFacilityForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(editFacilityForm);
                const updatedFacility = {
                    id: currentEditingFacilityId,
                    name: formData.get('name'),
                    prefecture: formData.get('prefecture'),
                    city: formData.get('city'),
                    address: formData.get('address'),
                    tel: formData.get('tel'),
                    website: formData.get('website'),
                    videoSeminarLink: formData.get('videoSeminarLink'),
                    description: formData.get('description'),
                    image: formData.get('image') || 'https://placehold.co/600x400/e2e8f0/64748b?text=No+Image',
                    services: Array.from(editFacilityServicesCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value),
                    ages: Array.from(editFacilityAgesCheckboxes.querySelectorAll('input:checked')).map(cb => cb.value),
                };

                // Find and update the facility in the array
                allFacilities = allFacilities.map(f => f.id === currentEditingFacilityId ? updatedFacility : f);
                alert('事業所情報が正常に更新されました！');
                editFacilityModalContainer.classList.add('hidden');
                renderResults(); // Re-render to show updated facility
            });

            // --- Delete Facility Function ---
            deleteFacilityBtn.addEventListener('click', () => {
                confirmDeleteModal.classList.remove('hidden');
            });

            confirmDeleteBtn.addEventListener('click', () => {
                allFacilities = allFacilities.filter(f => f.id !== currentEditingFacilityId);
                alert('事業所情報が正常に削除されました！');
                confirmDeleteModal.classList.add('hidden');
                editFacilityModalContainer.classList.add('hidden'); // Close edit modal if open
                renderResults(); // Re-render to reflect deletion
            });

            cancelDeleteBtn.addEventListener('click', () => {
                confirmDeleteModal.classList.add('hidden');
            });

            const init = () => {
                // 都道府県リストの動的生成
                prefectures.forEach(p => {
                    const prefButton = document.createElement('button');
                    prefButton.className = 'bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-md shadow transition transform hover:scale-105';
                    prefButton.textContent = p.name;
                    prefButton.dataset.name = p.name;
                    prefButton.addEventListener('click', () => selectPrefecture(p.name));
                    prefectureListContainer.appendChild(prefButton);
                });

                setupFilters();
                setupNavigation();
                setupModal();
                resetFiltersBtn.addEventListener('click', resetFilters);
                updateAuthUI(); // Initial UI update based on isAdmin status (false by default)
                renderResults(); // Initial render of facilities
            };

            // Ensure initApp is called only after the DOM is fully loaded
            document.addEventListener('DOMContentLoaded', initApp);
        } // initApp関数の閉じ括弧を追加
    </script>
</body>
</html>
